description.org --- description of the algorithm

Copyright (C) 2015 Roman V. Prikhodchenko



Author: Roman V. Prikhodchenko <chujoii@gmail.com>



  This file is part of scheduler.

  scheduler is free software: you can redistribute it and/or modify
  it under the terms of the GNU General Public License as published by
  the Free Software Foundation, either version 3 of the License, or
  (at your option) any later version.

  scheduler is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU General Public License for more details.

  You should have received a copy of the GNU General Public License
  along with scheduler.  If not, see <http://www.gnu.org/licenses/>.

* расписание 

Из-за того что предметы разной насыщенности, занятия по некоторым
предметам идут раз в две недели. У меня будет рассчитываться виртуальная
двухнедельная (без выходных) еденица времени.


Очень желательно чтобы первая неделя была равна второй неделе.

0..5 - первая неделя (по числителю)
6..11 - вторая неделя (по знаменателю)


Пример пустого расписания для одного кабинета

| часы \ дни      | 0 пн | 1 вт | 2 ср | 3 чт | 4 пт | 5 сб | 6 пн | 7 вт | 8 ср | 9 чт | 10 пт | 11 сб |
|-----------------+------+------+------+------+------+------+------+------+------+------+-------+-------|
| 0  8:00 -  9:35 |      |      |      |      |      |      |      |      |      |      |       |       |
| 1  9:45 - 11:20 |      |      |      |      |      |      |      |      |      |      |       |       |
| 2 11:30 - 13:05 |      |      |      |      |      |      |      |      |      |      |       |       |
| 3 13:30 - 15:05 |      |      |      |      |      |      |      |      |      |      |       |       |
| 4 15:15 - 16:50 |      |      |      |      |      |      |      |      |      |      |       |       |
| 5 17:00 - 18:35 |      |      |      |      |      |      |      |      |      |      |       |       |


Студенты разбиты на группы.  Но некоторые занятия проводятся с малым
количеством студентов поэтому группы делятся ДВЕ на подгруппы.  Но
иногда условия лаборатории таковы что делятся на ТРИ подгруппы.
Поэтому я буду делить на 2*3=6 микрогрупп из которых буду составлять подгруппы или группы.


- в группе приблизительно ~20 человек
- подгруппы   (две)   по  ~10 человек
- подгруппы   (три)   по   ~6 человек
- микрогруппы (шесть) по   ~3 человека

* начальные данные
** преподаватели
У каждого преподавателя будет список пожеланий. Если у преподавателя
нет пожеланий - то в качестве списка пожеланий будет взят стандартный список.

*** по времени
(teacher_by_time)
пожелания расставляются в виде чисел от 0 до 10

- 0 - жёсткое требование: нет возможности вести занятия в это время,
  ну пожалуйста
- 1 - нежелательно ставить занятие в это время (Остальные значения -
  степень желанности проводить занятие в это время)
- 2
- 3
- 4
- 5 - мне всё равно: будет занятие в это время или занятие будет в
  другое время - всё равно
- 6
- 7
- 8
- 9 - да, я всегда готов провести занятие в это время
- 10 - жёсткое требование: обязательно поставить занятие в это время
  (не используется потому что неизвестно какое занятие поставить)


**** вот как выглядит для меня

| часы \ дни      | 0 пн | 1 вт | 2 ср | 3 чт | 4 пт | 5 сб | 6 пн | 7 вт | 8 ср | 9 чт | 10 пт | 11 сб |
|-----------------+------+------+------+------+------+------+------+------+------+------+-------+-------|
| 0  8:00 -  9:35 |    1 |    1 |    0 |    1 |    1 |    1 |    1 |    1 |    0 |    1 |     1 |     1 |
| 1  9:45 - 11:20 |    9 |    9 |    0 |    9 |    9 |    4 |    9 |    9 |    0 |    9 |     9 |     4 |
| 2 11:30 - 13:05 |    9 |    9 |    0 |    9 |    9 |    4 |    9 |    9 |    0 |    9 |     9 |     4 |
| 3 13:30 - 15:05 |    9 |    9 |    0 |    9 |    9 |    4 |    9 |    9 |    0 |    9 |     9 |     4 |
| 4 15:15 - 16:50 |    1 |    1 |    0 |    1 |    1 |    1 |    1 |    1 |    0 |    1 |     1 |     1 |
| 5 17:00 - 18:35 |    1 |    1 |    0 |    0 |    0 |    1 |    1 |    1 |    0 |    1 |     1 |     1 |
| 6 ??:?? - ??:?? |    0 |    0 |    0 |    0 |    0 |    0 |    0 |    0 |    0 |    0 |     0 |     0 |

Очень желательно в середине недели (в среду) иметь свободный день: для
подготовки к лекциям, для подготовки диссертации, посещения
Национальной библиотеки Республики Карелия, проведения экспериментов в
лаборатории. Поэтому в среду 0 или 1

Занятия в 8:00 - тяжело поэтому 1

Предпочтительнее утренние занятия с 9:45   - поэтому им "9".

Поздние занятия - вызывают затруднения, а в четверг и пятницу по
числителю (например) у меня дополнительные занятия (хобби, спорт, ...).

Суббота - возможно но нежелательно.

**** стандартный список по умолчанию

| часы \ дни      | 0 пн | 1 вт | 2 ср | 3 чт | 4 пт | 5 сб | 6 пн | 7 вт | 8 ср | 9 чт | 10 пт | 11 сб |
|-----------------+------+------+------+------+------+------+------+------+------+------+-------+-------|
| 0  8:00 -  9:35 |    5 |    5 |    5 |    5 |    5 |    5 |    5 |    5 |    5 |    5 |     5 |     5 |
| 1  9:45 - 11:20 |    5 |    5 |    5 |    5 |    5 |    5 |    5 |    5 |    5 |    5 |     5 |     5 |
| 2 11:30 - 13:05 |    5 |    5 |    5 |    5 |    5 |    5 |    5 |    5 |    5 |    5 |     5 |     5 |
| 3 13:30 - 15:05 |    5 |    5 |    5 |    5 |    5 |    5 |    5 |    5 |    5 |    5 |     5 |     5 |
| 4 15:15 - 16:50 |    5 |    5 |    5 |    5 |    5 |    5 |    5 |    5 |    5 |    5 |     5 |     5 |
| 5 17:00 - 18:35 |    5 |    5 |    5 |    5 |    5 |    5 |    5 |    5 |    5 |    5 |     5 |     5 |
| 6 ??:?? - ??:?? |    5 |    5 |    5 |    5 |    5 |    5 |    5 |    5 |    5 |    5 |     5 |     5 |

*** по числу занятий
(teacher_by_num)
пожелания расставляются в виде чисел от 0 до 10, и рассчитываются
отдельно для каждого дня


- 0 - жёсткое требование: нет возможности проводить такое количество
  занятий в день, ну пожалуйста
- 1 - нежелательное количество занятий (Остальные значения - степень
  желанности количества занятий в день)
- 2
- 3
- 4
- 5 - мне всё равно: будет занятие в таком количестве или занятие
  будет в другом количестве - всё равно
- 6
- 7
- 8
- 9 - да, я всегда готов провести занятие в данном количестве
- 10 - жёсткое требование: обязательно поставить такое количество
  занятий в день (не используется)




**** вот как выглядит для меня

| число занятий в день | оценка | комментарий                                                                       |
|----------------------+--------+-----------------------------------------------------------------------------------|
|                    0 |      9 | как хорошо, если не будет ни одного занятия в день                                |
|                    1 |      1 | одно занятие в день слишком мало: я трачу больше времени на дорогу чем на занятие |
|                    2 |      2 | так себе                                                                          |
|                    3 |      9 | хорошо                                                                            |
|                    4 |      3 | так себе                                                                          |
|                    5 |      0 | Больше четырёх слишком тяжело                                                     |
|                    6 |      0 | Больше четырёх слишком тяжело                                                     |
|                    7 |      0 | Больше четырёх слишком тяжело                                                     |

**** стандартный список по умолчанию

| число занятий в день | оценка | комментарий                                                                       |
|----------------------+--------+-----------------------------------------------------------------------------------|
|                    0 |      5 | как хорошо, если не будет ни одного занятия в день                                |
|                    1 |      1 | одно занятие в день слишком мало: я трачу больше времени на дорогу чем на занятие |
|                    2 |      3 | так себе                                                                          |
|                    3 |      4 | хорошо                                                                            |
|                    4 |      3 | так себе                                                                          |
|                    5 |      2 | Больше четырёх слишком тяжело                                                     |
|                    6 |      1 | Больше четырёх слишком тяжело                                                     |
|                    7 |      0 | Больше четырёх слишком тяжело                                                     |


*** окна
(teacher_by_window)
"окна" - пустое занятие между существующими занятиями

пожелания расставляются в виде чисел от 0 до 10, и рассчитываются
отдельно для каждого дня


- 0 - жёсткое требование: нет возможности бездельничать такое
  количество времени в день, ну пожалуйста
- 1 - нежелательное количество окон (Остальные значения - степень
  желанности количества занятий в день)
- 2
- 3
- 4
- 5 - мне всё равно: будут окна в таком количестве или окна будет в
  другом количестве - всё равно
- 6
- 7
- 8
- 9 - да, я как раз собирался в столовку
- 10 - жёсткое требование: обязательно поставить такое количество
  занятий в день (не используется)



**** вот как выглядит для меня

| число окон в день | оценка | комментарий                                                                  |
|-------------------+--------+------------------------------------------------------------------------------|
|                 0 |      9 | как хорошо, если не будет ни одного окна в день                              |
|                 1 |      1 | для меня окно - плохо                                                        |
|                 2 |      0 | а два окна ну совсем плохо                                                   |
|                 3 |      0 |                                                                              |
|                 4 |      0 |                                                                              |
|                 5 |      0 | это значит пришёл на первую пару, потом 5 окон, в конце дня провёл одну пару |

**** стандартный список по умолчанию

| число окон в день | оценка | комментарий                                                                  |
|-------------------+--------+------------------------------------------------------------------------------|
|                 0 |      3 | как хорошо, если не будет ни одного окна в день                              |
|                 1 |      2 | окно - плохо                                                                 |
|                 2 |      1 | а два окна ну совсем плохо                                                   |
|                 3 |      0 |                                                                              |
|                 4 |      0 |                                                                              |
|                 5 |      0 | это значит пришёл на первую пару, потом 5 окон, в конце дня провёл одну пару |


** студенты

аналогично преподавателям
student_by_time, student_by_num, student_by_window
** аудитории, кабинеты

бывают специализированные (лаборатории, компьютерные классы, большие залы)

| номер аудитории | количество микрогрупп | специализация |
|-----------------+-----------------------+---------------|
|               1 |                     9 | лекционная    |
|               2 |                     1 | лаборатория   |
|               3 |                       |               |
|               4 |                     0 |               |
|             ... |                   ... |               |
|             361 |                   200 | лекционная    |

** занятия

пример:

| № | преподаватель | микрогруппа(ы)   | предмет         | специфика кабинета         |
|---+---------------+------------------+-----------------+----------------------------|
| 1 | иванов        | 1, 2, 3, 4, 5, 6 | физика лекция   | любая лекционная аудитория |
| 2 | петров        | 1, 2, 3          | физика практика | обязательно кабинет 12     |
| 3 | петров        | 4, 5, 6          | физика практика | обязательно кабинет 12     |

** другие факторы
- на некоторых кафедрах имеются ноутбуки и проекторы, которые могут
  быть необходимы на лекциях
- некоторые занятия могут затянуться - лучше их делать последними или
  выносить в отдельный день (физкультура, долгие эксперименты)
- факультет размещается в двух зданиях и желательно переход между ними
  в один день делать как можно реже

* алгоритм 
** Составление первоначального расписания
генерируется таблица (пустой бланк расписания или от предыдущей
итерации), содержащая список занятий



** Способ составления расписания
Занятия добавляются в расписание одним из
методов:
- случайный метод (МонтеКарло) - наиболее простой для реализации
- перебором - метод полного перебора скорее всего не сработает:
  слишком много данных. Необходимо модифицировать метод
- используя сортировку
- нечто похожее на перцептрон

*** Метод "сортировки"
# fixme: поменять название
1. сортируем не попавшие в расписание занятия по предпочтениям:
   вначале расставляем занятие с жёсткими требованиям (случайным или
   другим методом)
2. если у преподавателя запрещены окна и в данный день не превышен
   лимит по количеству занятий, то ставим случайное занятие этого
   преподавателя сразу (после ИЛИ до) только что добавленного в
   расписание занятия [правильнее: после ИЛИ до группы занятий
   преподавателя]
3. повторяем пункт 2 до тех пор пока не превысим лимит по количеству
   занятий либо не превысим некоторое случайное число в диапазоне от 0
   до максимального числа занятий в день
4. переходим к пункту 1 до тех пор пока не расставим все занятия

*** Метод похожий на "перцептрон"
1. составляем таблицу занятий ()
2. составляем таблицу расписания с осями: время, дни, кабинеты.
   В каждой ячейке расписания - список кандидатов:

   (list '(занятие_1, весовой_коэффициент_1) '(занятие_2, весовой_коэффициент_2) ...)

   где
   - вместо "занятие_1" хранится просто номер 1

   - весовой коэффициент рассичтываем по формуле:
     weight_coefficient = teacher_by_time * student_by_time 
   
   Если занятие не подходит хотя бы под одну из координат:
   - время, например: число 0 - жёсткое требование: нет возможности
     вести занятия в это время
   - день аналогично
   - кабинет просто не соответствует критерию
     
   то его вообще не заносим в этот список.
3. после того как расписание заполнено, поощряем весовые коэффициенты
   тех занятий, которые подходят под остальные (неучтённые во втором
   пункте) пожелания и помещаем результаты расчётов в новое расписание
   (необходимо использовать именно новое расписание - потому что иначе
   расчёты, использующие весовые коэффициенты соседних занятий, могут
   повлиять только на последующие рассчёты но не на предыдущие -
   следовательно рассчёт будет несимметричным):

   для каждого занятия (кандидата в расписании), например "K12p",
   рассматриваем соседние ячейки M: "M1", "M2", ... (только по оси
   времени) исключая занятия в это же время (все "k" в этом и других
   кабинетах):
   
   
   кабинет 1
   | часы \ дни        | 0 пн | 1 вт                        | 2 ср | 3 чт | 4 пт | 5 сб | 6 пн | 7 вт | 8 ср | 9 чт | 10 пт | 11 сб |
   |-------------------+------+-----------------------------+------+------+------+------+------+------+------+------+-------+-------|
   | 0  8:00 -  9:35   |      | (M1 M2 M3 M4)               |      |      |      |      |      |      |      |      |       |       |
   | 1  9:45 - 11:20   |      | (M5 M6 *M7p* M8 M9)         |      |      |      |      |      |      |      |      |       |       |
   | 2 11:30 - 13:05   |      | (*M10p* M11)                |      |      |      |      |      |      |      |      |       |       |
   | *3 13:30 - 15:05* |      | (k1p k2 k3 k4 k5 k6 k7)     |      |      |      |      |      |      |      |      |       |       |
   | 4 15:15 - 16:50   |      | (*M12p* M13 M14 *M15p* M16) |      |      |      |      |      |      |      |      |       |       |
   | 5 17:00 - 18:35   |      | (M17)                       |      |      |      |      |      |      |      |      |       |       |
   
   M12p M15p - разные занятия одного и того же преподавателя претендуют на одно место

   кабинет 2
   | часы \ дни        | 0 пн | 1 вт                          | 2 ср | 3 чт | 4 пт | 5 сб | 6 пн | 7 вт | 8 ср | 9 чт | 10 пт | 11 сб |
   |-------------------+------+-------------------------------+------+------+------+------+------+------+------+------+-------+-------|
   | 0  8:00 -  9:35   |      | (M18 M19 M20)                 |      |      |      |      |      |      |      |      |       |       |
   | 1  9:45 - 11:20   |      | (M21 M22 M23 M24 M25)         |      |      |      |      |      |      |      |      |       |       |
   | 2 11:30 - 13:05   |      | (M26 M27 М28 М29 М30 М31)     |      |      |      |      |      |      |      |      |       |       |
   | *3 13:30 - 15:05* |      | (k8 k9 /k10p/ k11 *K12p* k13) |      |      |      |      |      |      |      |      |       |       |
   | 4 15:15 - 16:50   |      | (*M32p* M33 M34 M35)          |      |      |      |      |      |      |      |      |       |       |
   | 5 17:00 - 18:35   |      | (M36 M37 M38 *M39p*)          |      |      |      |      |      |      |      |      |       |       |
   
   ...
   
   кабинет 99
   | часы \ дни        | 0 пн | 1 вт                 | 2 ср | 3 чт | 4 пт | 5 сб | 6 пн | 7 вт | 8 ср | 9 чт | 10 пт | 11 сб |
   |-------------------+------+----------------------+------+------+------+------+------+------+------+------+-------+-------|
   | 0  8:00 -  9:35   |      | (M40)                |      |      |      |      |      |      |      |      |       |       |
   | 1  9:45 - 11:20   |      | (M41 *M42p* M43 M44) |      |      |      |      |      |      |      |      |       |       |
   | 2 11:30 - 13:05   |      | (*M45p* M46 M47 M48) |      |      |      |      |      |      |      |      |       |       |
   | *3 13:30 - 15:05* |      | (k14 /k15p/ k16 k17) |      |      |      |      |      |      |      |      |       |       |
   | 4 15:15 - 16:50   |      | (*M49p*)             |      |      |      |      |      |      |      |      |       |       |
   | 5 17:00 - 18:35   |      | ()                   |      |      |      |      |      |      |      |      |       |       |
   
   
   - если среди кандидатов из расписания "M" есть занятия того же
     преподавателя (M7p, M10p, M12p, M15p, M32p, M39p, M42p, M45p, M49p) и их число близко(3,3,4 ) к значению
     из таблицы teacher_by_num (teacher_by_num(K) = 3), то весовой коэффициент увеличиваем на
     lesson_mark_addonce, рассчитанный по формуле:
     
     lesson_mark_addonce = teacher_by_num(K) * сумма всех весовых коэффициентов M*p

     lesson_mark_addonce = teacher_by_num(K) *
     (весовой_коэффициент_M7p + весовой_коэффициент_M10p +
     весовой_коэффициент_M12p + весовой_коэффициент_M15p +
     весовой_коэффициент_M32p + весовой_коэффициент_M39p +
     весовой_коэффициент_M42p + весовой_коэффициент_M45p +
     весовой_коэффициент_M49p)
     
     то есть поощряем те занятия которые удовлетворяют определённым условиям


   - аналогично для коэффициентов teacher_by_window, student_by_num, student_by_window

4. отбрасываем старое расписание и дальше работаем с новым
5. находим занятия с самыми большими весовыми коэффициентами 
6. находим занятия с самыми маленькими весовыми коэффициентами 

1000. проверяем все ли занятия распределены по 

** Оценка расписания
Если остались неразмещённые занятия то оценка 0.
# fixme оценка = (оценка - 100) ?


Для каждого занятия рассчитывается коэффициент по формуле:

lesson_mark = teacher_by_time * teacher_by_num * teacher_by_window *
              student_by_time * student_by_num * student_by_window

оценка расписания = (сумма всех lesson_mark) + (коэффициент равенства первой и второй недели)
